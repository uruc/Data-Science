---
title: "Tidy-Tuesday Geospatial"
subtitle: "Ibrahim Uruc Tarim"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: yes
  pdf_document:
    latex_engine: xelatex
    toc: true
    number_sections: true
    toc_depth: 6
    highlight: tango
urlcolor: blue
---

```{r, setup, include = FALSE}
knitr::opts_chunk$set(
  cache = FALSE, # if TRUE knitr will cache results to reuse in future knits
  fig.width = 6, # the width for plots created by code chunk
  fig.height = 4.5, # the height for plots created by code chunk
  fig.align = 'center', # how to align graphics. 'left', 'right', 'center'
  dpi = 300,
  dev = 'png',
  # results = 'asis', # knitr passes through results without reformatting
  echo = TRUE, # if FALSE knitr won't display code in chunk above it's results
  message = FALSE, # if FALSE knitr won't display messages generated by code
  strip.white = TRUE, # if FALSE knitr won't remove white spaces at beg or end
  warning = FALSE) # if FALSE knitr won't display warning messages in the doc

```


```{r packages, echo = FALSE, include = FALSE}
library(kableExtra)
library(tidyverse)
library(ggpubr)
library(ggridges)
library(lubridate)

```

________________________________________________________________________________


```{r, styleguide}
first_custom <- function() {
  theme_minimal() +
    theme(
      axis.line = element_line(color = "gray0"),
      plot.background  = element_rect(fill = "grey95"),
      panel.grid.major = element_line(linewidth = 0.5, color = "gray80"),
      panel.grid.minor = element_blank(),
      #panel.grid.minor = element_line(color = "gray85"),
      plot.margin = margin(15, 15, 15 ,15),
      plot.title = element_text(face = "bold"),
      plot.title.position = "plot",
      plot.caption = element_text(size = 8, face = "italic"),
      plot.caption.position = "plot",
      legend.background = element_rect(),
      legend.justification = (c(1,0)),
      legend.text = element_text(size = 8),
      legend.title = element_text(size = 8),
      legend.key.size = unit(0.25, "cm")
    )
}

```

# Tidy Tuesday Description {-}

**Taken from the GitHub repo**

The TidyTuesday Project is a weekly data project aimed at the R ecosystem. As this project was born out of the R4DS Online Learning Community and the R for Data Science textbook, an emphasis was placed on understanding how to summarize and arrange data to make meaningful charts with ggplot2, tidyr, dplyr, and other tools in the tidyverse ecosystem,  but other packages are more than welcome.

Every week they post a raw dataset, a chart or article related to that dataset, and ask participants to explore the data. While the dataset will be “tamed”, it will not always be tidy! As such you might need to apply various R for Data Science techniques to wrangle the data into a true tidy format. For this lab, we won't require you to do much cleaning. The goal of TidyTuesday is to apply your R skills, get feedback, explore other’s work, and connect with the greater #RStats community!

TidyTuesday is intended to be a safe and supportive environment.

________________________________________________________________________________

# Choosing Data, Exploring/Cleaning, and Tables

  
The [TidyTuesday Repo](https://github.com/rfordatascience/tidytuesday) contains weekly datasets for the last four years. There is a lot of documentation on the repo, please check it out. If you're looking for some inspiration, #TidyTuesday is a popular hashtag on Twitter and other platforms.

  - Some datasets have a _clean_ version, please use this one if its available. 
  - Some TidyTuesday folders have multiple datasets in them, you can use one or all of these. Just make sure your analysis includes the required components.
  
## Lets Find Some Data 

  
```{r LE5-1aANSWER}

rainfall <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-01-07/rainfall.csv')
temperature <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-01-07/temperature.csv')

temperature <- temperature %>% 
  mutate(year = as.numeric(format(date, "%Y",)),
         month = as.numeric(format(date, "%m")))

temperature$city_name = toupper(temperature$city_name)
rainfall$city_name = toupper(rainfall$city_name)

```

Rainfall and Temperature data of Australia 
https://github.com/rfordatascience/tidytuesday/blob/master/data/2020/2020-01-07/readme.md

```{r}
library(viridis)

# Find the intersection of city names
common_cities <- intersect(temperature$city_name, rainfall$city_name)

# Filter both datasets to keep only the common cities
temperature <- temperature %>%
  filter(city_name %in% common_cities)
rainfall <- rainfall %>%
  filter(city_name %in% common_cities)

temperature <- temperature %>% 
  mutate(year = as.numeric(format(date, "%Y",)),
         month = as.numeric(format(date, "%m")))

temperature$city_name = toupper(temperature$city_name)
rainfall$city_name = toupper(rainfall$city_name)

temp_recent_mean <- temperature %>%
  filter(year >= 2000, year <= 2019) %>%
  mutate(city_name = str_to_title(city_name)) %>%
  filter(temp_type == "max") %>%
  group_by(year, city_name) %>%
  summarise(temperature = mean(temperature, na.rm = TRUE), .groups='drop')

ggplot(temp_recent_mean, aes(fill=city_name, x=year, y=temperature, color=city_name)) +
  geom_line() +
  facet_wrap(~city_name, nrow=3) +
  scale_x_continuous(name="Year", breaks=seq(2000, 2019, 5)) +
  scale_y_continuous(name="Max Temp in Celsius", breaks=seq(14, 30, 2)) +
  ggtitle("Temperature Variation in Each City: 2000-2019") +
  theme(legend.position="none")

rain_recent_mean <- rainfall %>%
  filter(year >= 2000, year <= 2019) %>%
  group_by(year, city_name) %>%
  summarise(mean_rain = mean(rainfall, na.rm=TRUE), .groups='drop') %>%
  arrange(desc(mean_rain))

ggplot(rain_recent_mean, aes(fill=city_name, x=year, y=mean_rain, color=city_name)) +
  geom_line() +
  geom_point() +
  scale_x_continuous(name="Year", breaks=seq(2000, 2019, 5)) +
  scale_y_continuous(name="Average Rain in mm", breaks=seq(1, 8, 1)) +
  facet_wrap(~city_name) +
  ggtitle("Average Rainfall in Cities: 2000-2019") +
  theme(legend.position="none", axis.text.x=element_text(size=6))


```
## Tables

```{r LE5-1c ANSWER}
library(dplyr)
library(knitr)

# Find common cities
common_cities <- intersect(temperature$city_name, rainfall$city_name)

# Filter datasets to keep only common cities and specified years
temp_recent_common <- temperature %>%
  filter(city_name %in% common_cities, year >= 2000, year <= 2019)

rain_recent_common <- rainfall %>%
  filter(city_name %in% common_cities, year >= 2000, year <= 2019)

# Calculate temperature summary statistics
summary_stats_temp <- temp_recent_common %>%
  group_by(city_name, year) %>%
  summarize(
    mean_temp = mean(temperature, na.rm = TRUE),
    median_temp = median(temperature, na.rm = TRUE),
    min_temp = min(temperature, na.rm = TRUE),
    max_temp = max(temperature, na.rm = TRUE),
    .groups = 'drop'
  )

# Calculate rainfall summary statistics
summary_stats_rain <- rain_recent_common %>%
  group_by(city_name, year) %>%
  summarize(
    mean_rain = mean(rainfall, na.rm = TRUE),
    median_rain = median(rainfall, na.rm = TRUE),
    percentile_75_rain = quantile(rainfall, 0.75, na.rm = TRUE),
    total_rain = sum(rainfall, na.rm = TRUE),
    .groups = 'drop'
  )

# Output summary tables
kable(summary_stats_temp, "html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  scroll_box(width = "100%", height = "500px")

kable(summary_stats_rain, "html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  scroll_box(width = "100%", height = "500px")

```

Insights from Datasets:

 - Upward Temperature Trend: There is a noticeable upward trend in temperatures, particularly in the later years of the dataset, with several cities showing higher average and median temperatures. This is consistent with the global trend of rising temperatures and could be indicative of climate change effects.

 - Seasonal Variability: The wide range between the minimum and maximum temperatures for each city within each year indicates strong seasonal variability. This is expected, but the range also shows the potential for extreme weather events, as seen with some very high maximum temperatures.

 - Rainfall Variability: The rainfall data exhibits considerable yearly variability within cities, with certain years showing peaks that could correspond to specific heavy rainfall events. This suggests that rainfall is not consistent year-to-year and is subject to larger climatic patterns or events.

 - Data Quality: Initially, the median rainfall values being zero indicated potential data issues or many zero-rainfall days. However, the 75th percentile values showed that significant rainfall did occur, indicating the data likely captured actual variations in rainfall.

 - Extreme Values: The dataset contains some extreme temperature values, both hot and cold, which could warrant further investigation to understand if they are outliers, errors, or true weather phenomena.

 - Consistency Across Years: While there is year-to-year variation, the temperature data generally show a consistent pattern over the two-decade span, with the recent years standing out for their higher values.

# Time, Date, and Timeseries

## Time Conversion

Timeseries is all about a repeating trend. Sometimes you don't know that there is a recurring trend until you create the data as a timeseries. Here, we'll go ahead and use **ts()** on the variables that, in your opinion, it would make sense to apply it to.

The frequency argument inside **ts()** dictates how many observations should be considered in each cycle of the recurring trend.

 - weekly, monthly, yearly, etc.

```{r LE5-2ANSWER}
library(lubridate)
library(zoo)

rainfall$date <- as.Date(paste(rainfall$year, rainfall$month, rainfall$day, sep = "-"), "%Y-%m-%d")
temperature$date <- as.Date(temperature$date)

rainfall_filtered <- subset(rainfall, year >= 2000 & (year < 2019 | (year == 2019 & as.Date(paste(year, month, day, sep="-")) <= as.Date("2019-05-31"))))
temperature_filtered <- subset(temperature, year >= 2000 & (year < 2019 | (year == 2019 & date <= as.Date("2019-05-31"))))

rainfall_filtered %>% 
  summarise(across(everything(), ~sum(is.na(.))))

temperature_filtered %>% 
  summarise(across(everything(), ~sum(is.na(.))))

numeric_columns <- sapply(rainfall_filtered, is.numeric)
rainfall_filtered[numeric_columns] <- lapply(rainfall_filtered[numeric_columns], function(x) {ifelse(is.na(x), 0, x)})

temperature_filtered <- na.omit(temperature_filtered)

yearly_rainfall_by_city <- aggregate(rainfall ~ city_name + year, data = rainfall_filtered, sum)
yearly_temperature_by_city <- aggregate(temperature ~ city_name + year, data = temperature_filtered, mean)

monthly_rainfall_by_city <- aggregate(rainfall ~ city_name + year + month, data = rainfall_filtered, sum)
monthly_temperature_by_city <- aggregate(temperature ~ city_name + year + month, data = temperature_filtered, mean)

rainfall_list <- split(yearly_rainfall_by_city, yearly_rainfall_by_city$city_name)
temperature_list <- split(yearly_temperature_by_city, yearly_temperature_by_city$city_name)


rainfall_ts_list <- lapply(rainfall_list, function(df) {
    start_year <- ifelse(df$city_name[1] == "Canberra", 2008, min(df$year))
    end_year <- max(df$year)
    ts(df$rainfall, start=start_year, end=end_year, frequency=1)
})


temperature_ts_list <- lapply(temperature_list, function(df) {
    ts(df$temperature, start=min(df$year), end=max(df$year), frequency=1)
})

monthly_rainfall_list <- split(monthly_rainfall_by_city, monthly_rainfall_by_city$city_name)
monthly_temperature_list <- split(monthly_temperature_by_city, monthly_temperature_by_city$city_name)


monthly_rainfall_ts_list <- lapply(monthly_rainfall_list, function(df) {
    start_year <- ifelse(df$city_name[1] == "Canberra", 2008, min(df$year))
    ts(df$rainfall, start = c(start_year, min(df$month[df$year == start_year])), frequency = 12)
})

monthly_temperature_ts_list <- lapply(monthly_temperature_list, function(df) {
    ts(df$temperature, start = c(min(df$year), min(df$month)), frequency = 12)
})

# Function to convert a time series object to a data frame
convert_ts_to_df <- function(ts_obj, city_name, value_name) {
  years <- as.integer(time(ts_obj))
  values <- as.vector(ts_obj)
  data.frame(city_name = city_name, year = years, value = values, stringsAsFactors = FALSE)
}

# Convert each time series in the list to a data frame and then combine them
rainfall_df <- do.call(rbind, lapply(names(rainfall_ts_list), function(city) {
  convert_ts_to_df(rainfall_ts_list[[city]], city, "rainfall")
}))

temperature_df <- do.call(rbind, lapply(names(temperature_ts_list), function(city) {
  convert_ts_to_df(temperature_ts_list[[city]], city, "temperature")
}))
```
```{r}
library(stats)
library(tseries)
library(forecast)
library(tidyr)



adf_test_results_monthly_temperature <- lapply(monthly_temperature_ts_list, adf.test)
adf_test_results_monthly_temperature
```

```{r}
adf_test_results_monthly_rainfall <- lapply(monthly_rainfall_ts_list, adf.test)
adf_test_results_monthly_rainfall
```
```{r}
adf_test_results_yearly_rainfall <- lapply(rainfall_ts_list, adf.test)
adf_test_results_yearly_rainfall
```

```{r}
adf_test_results_yearly_temperature <- lapply(temperature_ts_list, adf.test)
adf_test_results_yearly_temperature
```


Which relationships are evident? Are they a long-term trend or do they just exhibit seasonality?

 - Monthly Temperature Dataset (First Set of Results):
Most cities (like Brisbane, Canberra, Kent, Melbourne) have high p-values (close to 0.99), suggesting non-stationarity, indicating the presence of trends in the monthly temperature data.

 - Monthly Rainfall Dataset (Second Set of Results):
Some cities (like Brisbane, Canberra, Melbourne, Sydney) show low p-values (e.g., < 0.05), indicating stationarity and thus no significant trend.
Other cities show high p-values, suggesting non-stationarity and potential trends.

 - Yearly Rainfall Dataset (Third Set of Results):
Cities like Perth show low p-values, indicating stationarity and no significant long-term trend.Other cities have higher p-values, suggesting potential trends.

 - Yearly Temperature Dataset (Fourth Set of Results):
Cities like Brisbane and Canberra show high p-values, indicating non-stationarity and possible trends.
Other cities, like Perth, show lower p-values, suggesting no significant long-term trend.

## Plotting

```{r LE5-2b ANSWER}
common_cities <- intersect(names(temperature_ts_list), names(rainfall_ts_list))

# Rainfall plot
rainfall_df_common <- do.call(rbind, lapply(common_cities, function(city) {
  convert_ts_to_df(rainfall_ts_list[[city]], city, "rainfall")
}))

ggplot(rainfall_df_common, aes(x = year, y = value, group = city_name, color = city_name)) +
  geom_line(lwd=1.1) +
  facet_wrap(~ city_name, scales = "free_x") +
  labs(title = "Yearly Rainfall by City (2000-2019)", x = "Year", y = "Total Rainfall") +
  first_custom() +
  theme(legend.position = "none") 

# Temperature plot
temperature_df_common <- do.call(rbind, lapply(common_cities, function(city) {
  convert_ts_to_df(temperature_ts_list[[city]], city, "temperature")
}))

ggplot(temperature_df_common, aes(x = year, y = value, group = city_name, color = city_name)) +
  geom_line(lwd=1.1) +
  facet_wrap(~ city_name, scales = "free_x") +
  labs(title = "Yearly Mean Temperature by City (2000-2019)", x = "Year", y = "Mean Temperature") +
  first_custom() +
  theme(legend.position = "none")

```

The plots of temperature and rainfall trends by city from 2000 to 2019 show:

Seasonal patterns are evident in both temperature and rainfall data.
There's a slight upward trend in temperatures for most cities, suggesting a warming pattern.
Rainfall data is more variable with no clear long-term trend.

Predicting 100 years into the future is complex, but if current warming trends persist, temperatures are likely to continue rising. Rainfall predictions are less certain due to their variability.

# Geospatial

## Plotting

Geospatial data can get very complicated very quickly with 

  - different coordinate systems
  - data formats like shapefile, raster, tiff
  - data grouping
  - and many different specialized packages for handling this data.
  
There are powerful applications like ArcGIS that specialize in processing this data. But we will be just fine with ggplot2. This week's TidyTuesday project happens to involve geospatial data!

  - `map_data()`
    - [Resource](https://rdrr.io/cran/maps/man/map.html)
  - `geom_sf()`
  - `group =`
  - `coord_quickmap()`
  
```{r LE5-3ANSWER}
library(sf)
library(raster)
library(dplyr)
library(ggrepel)
library(viridis)
library(ggplot2)
library(rnaturalearth)
library(rnaturalearthhires)
# Load Australia shapefile

australia <- rnaturalearth::ne_states(geounit = "australia")
sp::plot(australia)

# Load and plot raster data
grid_raster <- raster("2019120120191231.grid")

plot(grid_raster)

climate <- as(grid_raster, "SpatialPixelsDataFrame")
climate <- as.data.frame(climate)
climate <- climate %>%
  rename(temp = X2019120120191231)

# Select and clean Australia cities data
australia_cities <- rainfall %>%
  dplyr::select(city_name, long, lat) %>%
  distinct()
australia_cities <- australia_cities[-4,]

# Create the plot
tempdec <- ggplot() +
  geom_tile(data = climate, aes(x = x, y = y, fill = temp)) +
  geom_sf(data = australia, fill = NA, color = "#3E3E3E", size = 0.1) +
  geom_point(data = australia_cities, aes(x = long, y = lat), color = "white") +
  geom_text_repel(data = australia_cities, aes(x = long, y = lat, label = city_name), size = 3, color = "white") +
  scale_fill_viridis_c(option = "B") +
  coord_sf(crs = st_crs(australia)) +
  theme_void() +
  theme(
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    legend.background = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    plot.caption = element_text(vjust = 1.1, hjust = 1.3, size = 7),
    legend.position = "right",
    legend.justification = "center",
    legend.box.just = "right"
  ) +
  labs(
    title = "Australia Climate",
    subtitle = "Average High Temperatures for December 2019",
    caption = "Australian Bureau of Meteorology"
  )

# Plot the result
print(tempdec)


```

The plot is a thematic map depicting the average high temperatures across Australia for December 2019. It employs a gradient color scheme, where warmer colors represent higher temperatures, creating a visual representation of the heat distribution. Major cities are marked with white points, and labels provide clear identification, adding a spatial context to the temperature data.

________________________________________________________________________________

Links

- https://www.r-graph-gallery.com/time-series.html
- https://www.r-graph-gallery.com/line_chart_annotation.html
- https://www.r-graph-gallery.com/line-chart-dual-Y-axis-ggplot2.html
- https://fred.stlouisfed.org/
- http://austinwehrwein.com/
